name: Build Ouster SDK

on:
  workflow_run:
    workflows:
      - "Check Upstream Ouster SDK Release"
    types:
      - completed

  workflow_dispatch:
    inputs:
      tag:
        description: "Ouster SDK tag to build (e.g. v0.10.0)"
        required: true
        type: string

permissions:
  contents: write

env:
  VCPKG_BINARY_SOURCES: "clear;files,C:/vcpkg/bincache,readwrite"

jobs:
  build:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    strategy:
      fail-fast: false
      matrix:
        os: [
            ubuntu-latest,
            # macos-latest,
            windows-latest
        ]
        
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version to build
        shell: bash
        run: |
          git fetch --tags

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            TAG=$(git describe --tags --abbrev=0)
          fi

          echo "OUSTER_VERSION=${TAG}" >> $GITHUB_ENV
          echo "Building Ouster SDK version: ${TAG}"

      # -------------------------
      # Dependencies
      # -------------------------

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
            sudo apt-get update
            sudo apt-get install -y \
            cmake \
            libcurl4-openssl-dev \
            libtins-dev \
            libpcap-dev \
            libeigen3-dev \
            libpng-dev \
            zlib1g-dev \
            libflatbuffers-dev \
            libzip-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew uninstall -f eigen || true
          brew install \
            eigen@3 \
            cmake \
            curl \
            libtins \
            libpng \
            zlib \
            flatbuffers \
            libzip

      - name: Cache vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/buildtrees
            C:/vcpkg/packages
          key: vcpkg-${{ runner.os }}-x64-windows-release

      - name: Cache vcpkg binary cache (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
            path: C:/vcpkg/bincache
            key: vcpkg-bincache-${{ runner.os }}-x64-windows-release

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install eigen3 curl libpcap libtins libpng zlib flatbuffers libzip --triplet x64-windows-release

      # -------------------------
      # Build
      # -------------------------

      - name: Build (Linux)
        if: runner.os == 'Linux'
        run: |
          chmod +x scripts/build-linux.sh
          scripts/build-linux.sh

      - name: Build (macOS)
        if: runner.os == 'macOS'
        run: |
            export CMAKE_PREFIX_PATH="/opt/homebrew/opt/eigen@3:${CMAKE_PREFIX_PATH}"
            chmod +x scripts/build-macos.sh
            scripts/build-macos.sh

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: |
          scripts/build-windows.ps1

      # -------------------------
      # Package
      # -------------------------

      - name: Package artifacts (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p dist
          tar czf dist/ouster-sdk-${OUSTER_VERSION}-linux-x86_64.tar.gz ouster

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
            New-Item -ItemType Directory -Force -Path dist | Out-Null
            Compress-Archive `
              -Path ouster `
              -DestinationPath dist\ouster-sdk-$env:OUSTER_VERSION-windows-x64.zip

      - name: Package artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
            mkdir -p dist
            tar czf dist/ouster-sdk-${OUSTER_VERSION}-macos-arm64.tar.gz ouster

      # -------------------------
      # Release
      # -------------------------

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.OUSTER_VERSION }}
          files: dist/*
          fail_on_unmatched_files: true
